<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/utils/render-status.html">
<link rel="import" href="../grain-update-inline-style-behavior/grain-update-inline-style-behavior.html">
<link rel="import" href="../grain-responsive-behavior/grain-responsive-behavior.html">
<link rel="import" href="grain-masonry-import.html">

<style>
	.grain-masonry-animate-move-up {
		transform: translateY(200px);
		opacity: 0;
		animation: containerMasonryMoveToOrigin 0.65s ease forwards;
	}

	.grain-masonry-animate-move-down {
		transform: translateY(-200px);
		opacity: 0;
		animation: containerMasonryMoveToOrigin 0.65s ease forwards;
	}

	@keyframes containerMasonryMoveToOrigin {
		0% { }
		100% { transform: translateY(0); opacity: 1; }
	}
</style>

<dom-module id="grain-masonry">
	<template>
		<style>
			:host {
				display: block;
				width: 100%;
			}
		</style>

		<slot></slot>
	</template>

	<script>

		class GrainMasonry extends GrainUpdateInlineStyleBehavior(GrainResponsiveBehavior(Polymer.Element)) {

			static get is() { return 'grain-masonry' }

			static get properties() {
				return {
					itemSelector: {
						type: String,
						reflectToAttribute: true,
						value: 'article'
					},
					transitionDuration: {
						type: Number,
						reflectToAttribute: true,
						value: 0
					}
				};
			}

			ready() {
				super.ready();

				this.raw = new Masonry(this, {
					itemSelector: this.itemSelector,
					transitionDuration: this.transitionDuration,
					initLayout: false
				});

				this.addEventListener('load', function(event){
					let target = event.target;
					if (target.tagName === 'IMG') {
						this.layout();
					}
				}.bind(this), true);

				Polymer.RenderStatus.afterNextRender(this, function() {
					this.layout();
				});
			}

			layout() {
				this.raw.layout();
			}

			appendChild(element) {
				element.classList.add('grain-masonry-animate-move-up');
				element.addEventListener('animationend', function (event) {
					event.target.classList.remove('grain-masonry-animate-move-up');
				});
				super.appendChild(element);
				this.raw.addItems(element);
				Polymer.RenderStatus.afterNextRender(this, function() {
					this.layout();
				});
			}

			insertBefore(element, before) {
				element.classList.add('grain-masonry-animate-move-down');
				element.addEventListener('animationend', function (event) {
					event.target.classList.remove('grain-masonry-animate-move-down');
				});
				super.insertBefore(element, before);
				this.raw.prepended(element);
				Polymer.RenderStatus.afterNextRender(this, function() {
					this.layout();
				});
			}

		}

		customElements.define(GrainMasonry.is, GrainMasonry);
	</script>
</dom-module>
